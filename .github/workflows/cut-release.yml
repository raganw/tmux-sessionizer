name: Cut Release

on:
  workflow_dispatch:
    inputs:
      version_bump_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      custom_version:
        description: 'Custom version (optional, overrides version_bump_type if provided)'
        required: false
        type: string

env:
  CARGO_TERM_COLOR: always

jobs:
  cut-release:
    name: Cut Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      repository-projects: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Install cargo-edit
        run: cargo install cargo-edit

      - name: Get current version
        id: current_version
        run: |
          CURRENT_VERSION=$(grep '^version = ' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Calculate new version
        id: new_version
        run: |
          if [ -n "${{ github.event.inputs.custom_version }}" ]; then
            NEW_VERSION="${{ github.event.inputs.custom_version }}"
            echo "Using custom version: $NEW_VERSION"
          else
            CURRENT_VERSION="${{ steps.current_version.outputs.current_version }}"
            IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
            
            case "${{ github.event.inputs.version_bump_type }}" in
              "major")
                NEW_VERSION="$((major + 1)).0.0"
                ;;
              "minor")
                NEW_VERSION="$major.$((minor + 1)).0"
                ;;
              "patch")
                NEW_VERSION="$major.$minor.$((patch + 1))"
                ;;
              *)
                echo "Invalid version bump type"
                exit 1
                ;;
            esac
            echo "Calculated new version: $NEW_VERSION"
          fi
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update version in Cargo.toml
        run: |
          cargo set-version ${{ steps.new_version.outputs.new_version }}
          echo "Updated Cargo.toml version to ${{ steps.new_version.outputs.new_version }}"

      - name: Verify version update
        run: |
          NEW_VERSION_FROM_CARGO=$(grep '^version = ' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
          if [ "$NEW_VERSION_FROM_CARGO" != "${{ steps.new_version.outputs.new_version }}" ]; then
            echo "Error: Version mismatch after update"
            echo "Expected: ${{ steps.new_version.outputs.new_version }}"
            echo "Found: $NEW_VERSION_FROM_CARGO"
            exit 1
          fi
          echo "Version successfully updated to $NEW_VERSION_FROM_CARGO"

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        id: create_pr
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(release): v${{ steps.new_version.outputs.new_version }}"
          branch: release/v${{ steps.new_version.outputs.new_version }}
          base: main
          title: "chore(release): v${{ steps.new_version.outputs.new_version }}"
          body: |
            ## Release v${{ steps.new_version.outputs.new_version }}
            
            This PR bumps the version from ${{ steps.current_version.outputs.current_version }} to ${{ steps.new_version.outputs.new_version }}.
            
            **Changes:**
            - Updated version in `Cargo.toml`
            - Updated `Cargo.lock`
            
            This PR will auto-merge once required checks pass.
          
      - name: Handle PR Creation Error
        if: failure()
        run: |
          echo "‚ùå Failed to create pull request"
          echo ""
          echo "This is likely because GitHub Actions doesn't have permission to create pull requests in this repository."
          echo ""
          echo "To fix this issue, please:"
          echo "1. Go to your repository Settings ‚Üí Actions ‚Üí General"
          echo "2. Under 'Workflow permissions', ensure 'Allow GitHub Actions to create and approve pull requests' is checked"
          echo ""
          echo "Alternatively, you can create the release manually:"
          echo "1. A release branch 'release/v${{ steps.new_version.outputs.new_version }}' has been created with the version bump"
          echo "2. Create a pull request from this branch to main"
          echo "3. Once merged, the tag will be created automatically"
          exit 1

      - name: Enable auto-merge
        if: steps.create_pr.outputs.pull-request-number != ''
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.create_pr.outputs.pull-request-number }}
          merge-method: squash

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.create_pr.outputs.pull-request-number }}" != "" ]; then
            echo "‚úÖ Successfully created release PR for v${{ steps.new_version.outputs.new_version }}"
            echo "üì¶ Previous version: ${{ steps.current_version.outputs.current_version }}"
            echo "üöÄ New version: ${{ steps.new_version.outputs.new_version }}"
            echo "üåø Release branch: release/v${{ steps.new_version.outputs.new_version }}"
            echo "üîó Pull Request: ${{ steps.create_pr.outputs.pull-request-url }}"
            echo ""
            echo "The PR has auto-merge enabled and will merge automatically once required checks pass."
            echo "After the PR merges, the tag workflow will create the release tag and trigger the release build."
          else
            echo "‚ö†Ô∏è  Version was updated but PR creation failed"
            echo "üì¶ Previous version: ${{ steps.current_version.outputs.current_version }}"
            echo "üöÄ New version: ${{ steps.new_version.outputs.new_version }}"
            echo "üåø Release branch: release/v${{ steps.new_version.outputs.new_version }}"
            echo ""
            echo "A release branch has been created with the updated version."
            echo "You can manually create a PR from this branch to continue the release process."
          fi